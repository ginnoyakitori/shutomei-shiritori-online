<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>クイズ早押し！</title>
    <style>
        html, body {
            overscroll-behavior: none;
            touch-action: manipulation;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            text-align: center;
        }

        body {
            padding: 0px;
        }

        input, button, select {
            font-size: 1rem;
            margin: 5px;
            padding: 0px;
        }

        #lobby-box, #quiz-box, #result-box {
            display: none;
            max-width: 500px;
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        #answer {
            font-size: 1.6em;
            width: 90%;
            padding: 0px;
            margin-bottom: 12px;
            border: 2px solid #ccc;
            border-radius: 6px;
            background: #f9f9f9;
        }

        #question-number {
            font-weight: bold;
            margin-bottom: 0em;
            font-size: 1.1rem;
            color: #333;
        }

        #top-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 400px;
            margin: 0 auto 0px auto;
        }

        #timer {
            font-weight: bold;
            margin-bottom: 0em;
            font-size: 1.1rem;
            color: #333;
        }

        #question-number {
            font-size: 1.2em;
            text-align: right;
        }

        /* ボタン共通設定 */
        .flick-btn, #control-row button {
            position: relative;
            width: 70px;
            max-width: 70px;
            height:70px;
            max-height: 70px;
            background: #eef;
            font-size: 2em;
            border-radius: 8px;
            border: none;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            touch-action: none;
            box-sizing: border-box;
            overflow: hidden;
        }

        #flick-grid {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            grid-template-rows: repeat(4, 65px);
            gap: 15px;
            justify-content: center;
            margin: 0 auto;
            transform: translate(-2px, -4px);
        }

        .flick-btn .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            font-weight: bold;
            color: #000;
        }

        .flick-btn .hint {
            position: absolute;
            font-size: 0.6em;
            opacity: 0.6;
            pointer-events: none;
            color: #000;
        }

        .flick-btn .top { top: -3px; left: 50%; transform: translateX(-50%); }
        .flick-btn .right { right: -3px; top: 50%; transform: translateY(-50%); }
        .flick-btn .bottom { bottom: -3px; left: 50%; transform: translateX(-50%); }
        .flick-btn .left { left: -3px; top: 50%; transform: translateY(-50%); }

        #control-row {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: -2px;
            touch-action: none;
            transform: translate(0, -65px);
        }
        #modify-btn, #clear-btn {
            width: 70px;
            height: 70px;
            font-size: 2.5em;
            font-weight: bold;
            border-radius: 10px;
            border: none;
            background: #f4f4f4;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            touch-action: none;
        }

        #submit-btn {
            width: 60vw;
            max-width: 300px;
            height: 17vw;
            max-height: 80px;
            font-size: 1.6em;
            font-weight: bold;
            border-radius: 10px;
            background: #cce;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            margin-top:-7px;
            transform: translate(0, -52px);
        }
        #question {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 0em;
        }

        /* 部屋リスト */
        #room-list {
            margin-top: 20px;
            text-align: left;
            border-collapse: collapse;
            width: 100%;
        }
        #room-list th, #room-list td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        #room-list th {
            background-color: #f2f2f2;
        }
        #room-list tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .room-button {
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
        }
        .room-button.create {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .room-button.join {
            background-color: #008CBA;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .room-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* ルーム詳細画面 */
        #room-detail {
            margin-top: 20px;
            text-align: left;
        }
        #room-info p {
            margin: 5px 0;
        }
        #player-list {
            list-style: none;
            padding: 0;
        }
        #player-list li {
            background-color: #eee;
            margin-bottom: 5px;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-status {
            font-size: 0.8em;
            color: #666;
        }
        .player-status.ready {
            color: green;
            font-weight: bold;
        }
        .host-label {
            background-color: #ffeb3b;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        .ready-btn {
            background-color: #2196F3;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .ready-btn.unready {
            background-color: #f44336;
        }
        .ready-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* クイズタイプ選択 */
        #quiz-type-selection {
            margin-bottom: 15px;
        }
        #quiz-type-selection button {
            padding: 8px 15px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        #quiz-type-selection button.selected {
            background-color: #aaddff;
            border-color: #007bff;
        }

        /* ゲーム結果表示 */
        #result-box #game-over-message {
            font-size: 1.5em;
            color: #d32f2f;
            margin-bottom: 10px;
        }
        #result-box #correct-answerer-info {
            font-size: 1.3em;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 5px;
        }
        #result-box #correct-answer-display {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 20px;
        }
        #return-to-lobby-btn {
            background-color: #607d8b;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h1 id="main-title">クイズ早押し！</h1>

<div id="lobby-box">
    <h2>部屋一覧</h2>
    <table id="room-list">
        <thead>
            <tr>
                <th>部屋名</th>
                <th>人数</th>
                <th>ステータス</th>
                <th>パスワード</th>
                <th>クイズ</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
    
    <div id="create-room-modal" style="display: none; border: 1px solid #ccc; padding: 10px; margin-top: 20px; background-color: #fff;">
        <h3>新しい部屋を作成</h3>
        <input type="text" id="create-room-name" placeholder="部屋名" maxlength="20"><br>
        <input type="text" id="create-nickname" placeholder="あなたのニックネーム" maxlength="15"><br>
        <input type="password" id="create-room-password" placeholder="パスワード (任意)"><br>
        <button id="confirm-create-room-btn">作成</button>
        <button id="cancel-create-room-btn">キャンセル</button>
    </div>

    <div id="join-room-modal" style="display: none; border: 1px solid #ccc; padding: 10px; margin-top: 20px; background-color: #fff;">
        <h3 id="join-room-modal-title"></h3>
        <input type="text" id="join-nickname" placeholder="あなたのニックネーム" maxlength="15"><br>
        <input type="password" id="join-room-password" placeholder="パスワード (必要な場合)"><br>
        <button id="confirm-join-room-btn">入室</button>
        <button id="cancel-join-room-btn">キャンセル</button>
        <input type="hidden" id="joining-room-id">
    </div>
</div>

<div id="room-box">
    <div id="room-detail">
        <h2 id="current-room-name"></h2>
        <p>部屋ID: <span id="current-room-id"></span></p>
        <h3>プレイヤー:</h3>
        <ul id="player-list"></ul>

        <div id="host-controls" style="display: none;">
            <h4>クイズタイプを選択:</h4>
            <div id="quiz-type-selection">
                <button class="quiz-type-btn" data-type="kokumei">首都名から国名</button>
                <button class="quiz-type-btn" data-type="shutomei">国名から首都名</button>
            </div>
            <p id="selected-quiz-type-display"></p>
            <button id="start-game-btn" disabled>ゲームを開始</button>
        </div>

        <button id="ready-btn" class="ready-btn">準備完了</button>
        <button id="leave-room-btn" style="background-color: gray; color: white; margin-left: 10px; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">部屋を出る</button>
    </div>
</div>

<div id="quiz-box">
    <div id="top-info">
        <div id="question-number"></div>
        <div id="timer">0.00</div>
    </div>
    <div id="question"></div>

    <input id="answer" placeholder="答えを入力" readonly />
    <div id="flick-grid"></div>

    <div id="control-row">
        <button id="modify-btn">濁/小</button>
        <button class="flick-btn" data-base="わ">
            <span class="hint top">ン</span>
            <span class="hint right">ー</span>
            <span class="hint left">ヲ</span>
            <span class="center">ワ</span>
        </button>
        <button id="clear-btn">消</button>
    </div>

    <button id="submit-btn">解答</button>
    <div id="feedback"></div>
</div>

<div id="result-box">
    <p id="game-over-message"></p>
    <p id="correct-answerer-info"></p>
    <p id="correct-answer-display"></p>
    <p id="time-taken-display"></p>
    <button id="return-to-lobby-btn">待機画面に戻る</button>
</div>

<script type="module">
// Socket.IO クライアントの初期化
const socket = io();

// ===== DOM要素の取得 =====
const mainTitle = document.getElementById("main-title");
const lobbyBox = document.getElementById("lobby-box");
const roomListTableBody = document.querySelector("#room-list tbody");

const createRoomModal = document.getElementById("create-room-modal");
const createRoomNameInput = document.getElementById("create-room-name");
const createNicknameInput = document.getElementById("create-nickname");
const createRoomPasswordInput = document.getElementById("create-room-password");
const confirmCreateRoomBtn = document.getElementById("confirm-create-room-btn");
const cancelCreateRoomBtn = document.getElementById("cancel-create-room-btn");

const joinRoomModal = document.getElementById("join-room-modal");
const joinRoomModalTitle = document.getElementById("join-room-modal-title");
const joinNicknameInput = document.getElementById("join-nickname");
const joinRoomPasswordInput = document.getElementById("join-room-password");
const confirmJoinRoomBtn = document.getElementById("confirm-join-room-btn");
const cancelJoinRoomBtn = document.getElementById("cancel-join-room-btn");
const joiningRoomIdInput = document.getElementById("joining-room-id");

const roomBox = document.getElementById("room-box");
const currentRoomNameEl = document.getElementById("current-room-name");
const currentRoomIdEl = document.getElementById("current-room-id");
const playerListEl = document.getElementById("player-list");
const hostControls = document.getElementById("host-controls");
const quizTypeSelection = document.getElementById("quiz-type-selection");
const quizTypeBtns = document.querySelectorAll(".quiz-type-btn");
const selectedQuizTypeDisplay = document.getElementById("selected-quiz-type-display");
const startGameBtn = document.getElementById("start-game-btn");
const readyBtn = document.getElementById("ready-btn");
const leaveRoomBtn = document.getElementById("leave-room-btn");

const quizBox = document.getElementById("quiz-box");
const questionEl = document.getElementById("question");
const questionNumberEl = document.getElementById("question-number");
const timerEl = document.getElementById("timer");
const answerEl = document.getElementById("answer");
const feedbackEl = document.getElementById("feedback");
const submitBtn = document.getElementById("submit-btn");

const resultBox = document.getElementById("result-box");
const gameOverMessageEl = document.getElementById("game-over-message");
const correctAnswererInfoEl = document.getElementById("correct-answerer-info");
const correctAnswerDisplayEl = document.getElementById("correct-answer-display");
const timeTakenDisplayEl = document.getElementById("time-taken-display");
const returnToLobbyBtn = document.getElementById("return-to-lobby-btn");


// ===== グローバル変数 =====
let currentRoomId = null;
let myPlayerId = null;
let isHost = false;
let gameStartTime = null; // ゲームが開始された時刻

// ===== 初期表示 =====
showLobby();

// ===== 画面表示切り替え関数 =====
function showLobby() {
    lobbyBox.style.display = "block";
    roomBox.style.display = "none";
    quizBox.style.display = "none";
    resultBox.style.display = "none";
    mainTitle.style.display = "block";
    createRoomModal.style.display = "none";
    joinRoomModal.style.display = "none";
    currentRoomId = null;
    myPlayerId = null;
    isHost = false;
}

function showRoomWaiting() {
    lobbyBox.style.display = "none";
    roomBox.style.display = "block";
    quizBox.style.display = "none";
    resultBox.style.display = "none";
    mainTitle.style.display = "none";
}

function showQuizGame() {
    lobbyBox.style.display = "none";
    roomBox.style.display = "none";
    quizBox.style.display = "block";
    resultBox.style.display = "none";
    mainTitle.style.display = "none";
}

function showResult() {
    lobbyBox.style.display = "none";
    roomBox.style.display = "none";
    quizBox.style.display = "none";
    resultBox.style.display = "block";
    mainTitle.style.display = "none";
}

// ===== イベントリスナー =====

// 部屋作成ボタンクリック (動的に生成されるので親要素にイベント委譲)
roomListTableBody.addEventListener('click', (e) => {
    if (e.target.classList.contains('room-button')) {
        const roomId = e.target.dataset.roomId;
        if (e.target.classList.contains('create')) {
            // 作成モーダル表示
            createRoomModal.style.display = 'block';
            createRoomNameInput.value = '';
            createRoomPasswordInput.value = '';
        } else if (e.target.classList.contains('join')) {
            // 参加モーダル表示
            joinRoomModal.style.display = 'block';
            joinRoomModalTitle.textContent = `部屋「${e.target.dataset.roomName}」に参加`;
            joiningRoomIdInput.value = roomId;
            joinRoomPasswordInput.value = ''; // パスワード入力欄をリセット
            if (!e.target.dataset.hasPassword || e.target.dataset.hasPassword === "false") {
                joinRoomPasswordInput.style.display = 'none'; // パスワードなしなら非表示
            } else {
                joinRoomPasswordInput.style.display = 'block';
            }
        }
    }
});

// 部屋作成モーダル
confirmCreateRoomBtn.addEventListener('click', () => {
    const roomName = createRoomNameInput.value.trim();
    const nickname = createNicknameInput.value.trim();
    const password = createRoomPasswordInput.value;
    if (!roomName || !nickname) {
        alert('部屋名とニックネームは必須です。');
        return;
    }
    socket.emit('createRoom', { roomName, password, nickname });
    createRoomModal.style.display = 'none';
});

cancelCreateRoomBtn.addEventListener('click', () => {
    createRoomModal.style.display = 'none';
});

// 部屋参加モーダル
confirmJoinRoomBtn.addEventListener('click', () => {
    const roomId = joiningRoomIdInput.value;
    const nickname = joinNicknameInput.value.trim();
    const password = joinRoomPasswordInput.value;
    if (!nickname) {
        alert('ニックネームは必須です。');
        return;
    }
    socket.emit('joinRoom', { roomId, password, nickname });
    joinRoomModal.style.display = 'none';
});

cancelJoinRoomBtn.addEventListener('click', () => {
    joinRoomModal.style.display = 'none';
});


// 準備完了ボタン
readyBtn.addEventListener('click', () => {
    if (!currentRoomId) return;
    const player = document.getElementById(myPlayerId);
    const isReady = !player.dataset.ready || player.dataset.ready === 'false';
    socket.emit('setReady', { roomId: currentRoomId, isReady: isReady });
    readyBtn.textContent = isReady ? '準備解除' : '準備完了';
    readyBtn.classList.toggle('unready', isReady);
});

// 部屋を出るボタン
leaveRoomBtn.addEventListener('click', () => {
    socket.disconnect(); // 一度切断
    socket.connect(); // 再接続
    showLobby(); // ロビー画面に戻る
});

// クイズタイプ選択ボタン (ホストのみ)
quizTypeBtns.forEach(button => {
    button.addEventListener('click', () => {
        if (!isHost) return;
        const type = button.dataset.type;
        socket.emit('selectQuizType', { roomId: currentRoomId, type: type });
        quizTypeBtns.forEach(btn => btn.classList.remove('selected'));
        button.classList.add('selected');
    });
});

// ゲーム開始ボタン (ホストのみ)
startGameBtn.addEventListener('click', () => {
    if (!currentRoomId || !isHost) return;
    socket.emit('startGame', currentRoomId);
});

// 解答送信ボタン
submitBtn.addEventListener('click', () => {
    if (!currentRoomId) return;
    const answer = answerEl.value.trim();
    if (answer) {
        socket.emit('submitAnswer', currentRoomId, answer);
    }
});

// 待機画面に戻るボタン (結果画面からホストのみ)
returnToLobbyBtn.addEventListener('click', () => {
    if (!currentRoomId || !isHost) return; // ホストのみが操作可能
    socket.emit('returnToLobby', currentRoomId);
    // リセットはサーバーからのroomStateイベントでUIが更新される
});

// ===== Socket.IO イベントハンドラ =====

// 部屋リストの更新
socket.on('roomList', (rooms) => {
    roomListTableBody.innerHTML = '';
    rooms.forEach(room => {
        const row = roomListTableBody.insertRow();
        if (room.id === null) { // 空き部屋
            row.innerHTML = `
                <td>空き部屋</td>
                <td>0/${room.maxPlayers}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td><button class="room-button create" data-room-id="">ルームを作成</button></td>
            `;
        } else {
            row.innerHTML = `
                <td>${room.name}</td>
                <td>${room.playersCount}/${room.maxPlayers}</td>
                <td>${room.status === 'waiting' ? '待機中' : room.status === 'playing' ? 'ゲーム中' : '終了'}</td>
                <td>${room.hasPassword ? 'あり' : 'なし'}</td>
                <td>${room.quizType === 'kokumei' ? '首都名→国名' : room.quizType === 'shutomei' ? '国名→首都名' : '未設定'}</td>
                <td>
                    <button class="room-button join" data-room-id="${room.id}" data-room-name="${room.name}" data-has-password="${room.hasPassword}" ${room.status === 'playing' ? 'disabled' : ''}>入室</button>
                </td>
            `;
        }
    });
});

// 部屋作成成功
socket.on('roomCreated', (roomId) => {
    currentRoomId = roomId;
    myPlayerId = socket.id;
    isHost = true;
    showRoomWaiting();
});

// 部屋参加成功
socket.on('roomJoined', (roomId) => {
    currentRoomId = roomId;
    myPlayerId = socket.id;
    showRoomWaiting();
});

// 部屋のエラー
socket.on('roomError', (message) => {
    alert(message);
    showLobby(); // ロビーに戻る
});

// 部屋の状態更新
socket.on('roomState', (room) => {
    if (room.id !== currentRoomId) return; // 自分の部屋の情報でなければ無視

    currentRoomNameEl.textContent = room.name;
    currentRoomIdEl.textContent = room.id;
    
    playerListEl.innerHTML = '';
    room.players.forEach(player => {
        const li = document.createElement('li');
        li.id = player.id; // プレイヤーIDをliのIDに設定
        li.dataset.ready = player.ready; // ready状態をdatasetに保持
        li.innerHTML = `
            <span>${player.name}</span>
            ${player.isHost ? '<span class="host-label">HOST</span>' : ''}
            <span class="player-status ${player.ready ? 'ready' : ''}">
                ${player.ready ? '準備OK' : '未準備'}
            </span>
        `;
        playerListEl.appendChild(li);
    });

    // ホストコントロールの表示/非表示
    const myPlayer = room.players.find(p => p.id === myPlayerId);
    isHost = myPlayer ? myPlayer.isHost : false;
    if (isHost) {
        hostControls.style.display = 'block';
        // クイズタイプ選択ボタンの表示更新
        quizTypeBtns.forEach(btn => btn.classList.remove('selected'));
        if (room.quizType) {
            document.querySelector(`.quiz-type-btn[data-type="${room.quizType}"]`).classList.add('selected');
            selectedQuizTypeDisplay.textContent = `選択中のクイズ: ${room.quizType === 'kokumei' ? '首都名→国名' : '国名→首都名'}`;
        } else {
            selectedQuizTypeDisplay.textContent = 'クイズタイプを選択してください';
        }

        // ゲーム開始ボタンの有効/無効
        // ゲームが待機中で、かつクイズタイプが選択されていれば有効
        startGameBtn.disabled = !(room.status === 'waiting' && room.quizType && Object.keys(room.players).length >= 1);
        returnToLobbyBtn.style.display = (room.status === 'finished') ? 'block' : 'none'; // ホストでゲーム終了時のみ表示
    } else {
        hostControls.style.display = 'none';
        returnToLobbyBtn.style.display = 'none';
    }

    // 準備ボタンの表示更新
    if (myPlayer) {
        readyBtn.textContent = myPlayer.ready ? '準備解除' : '準備完了';
        readyBtn.classList.toggle('unready', myPlayer.ready);
        readyBtn.disabled = (room.status !== 'waiting'); // ゲーム中は準備ボタン無効
    }
    
    // 部屋が「終了」状態なら結果画面表示の準備
    if (room.status === 'finished') {
        showResult();
        gameOverMessageEl.textContent = `ゲーム終了！`;
        if (room.correctAnswerer && room.correctAnswererTime !== null) {
            correctAnswererInfoEl.innerHTML = `最も早かったのは **${room.correctAnswererName}** さん！<br>タイム: ${room.correctAnswererTime.toFixed(2)}秒`;
            correctAnswererInfoEl.style.color = '#2e7d32'; // 緑色
            correctAnswererInfoEl.style.fontWeight = 'bold';
        } else {
            correctAnswererInfoEl.textContent = '正解者はいませんでした...';
            correctAnswererInfoEl.style.color = '#d32f2f'; // 赤色
            correctAnswererInfoEl.style.fontWeight = 'normal';
        }
        correctAnswerDisplayEl.textContent = `正解は「${room.correctAnswer}」でした。`;
    }
});

// 新しいプレイヤーが参加
socket.on('playerJoined', (player) => {
    // roomStateイベントでまとめて更新されるので、ここでは特に何もしない
});

// プレイヤーが退出
socket.on('playerLeft', (playerId, playerName) => {
    // roomStateイベントでまとめて更新されるので、ここでは特に何もしない
});

// 新しいホストが設定された
socket.on('newHost', (newHostId) => {
    if (newHostId === myPlayerId) {
        alert('あなたが新しいホストになりました！');
    }
});

// ゲーム開始
socket.on('gameStarted', () => {
    showQuizGame();
    gameStartTime = Date.now(); // ゲーム開始時刻を記録
    feedbackEl.textContent = ''; // フィードバックをクリア
    answerEl.value = ''; // 回答欄をクリア
    timerEl.textContent = '0.00'; // タイマーリセット
});

// 新しい問題が出題
socket.on('newQuestion', (data) => {
    questionEl.textContent = data.text;
    questionNumberEl.textContent = `問題 ${data.questionNumber}`;
    answerEl.value = '';
    feedbackEl.textContent = '';
    submitBtn.disabled = false; // 解答ボタンを有効化
    answerEl.readOnly = false; // 入力欄を有効化
    gameStartTime = Date.now(); // 問題出題時刻を記録
    startTimer(); // タイマー開始
});

let timerIntervalId;
function startTimer() {
    if (timerIntervalId) clearInterval(timerIntervalId);
    timerIntervalId = setInterval(() => {
        const elapsed = (Date.now() - gameStartTime) / 1000;
        timerEl.textContent = `${elapsed.toFixed(2)}秒`;
    }, 10);
}

function stopTimer() {
    clearInterval(timerIntervalId);
    timerIntervalId = null;
}

// 正解者通知
socket.on('correctAnswer', (data) => {
    stopTimer(); // タイマー停止
    feedbackEl.textContent = '正解！';
    answerEl.readOnly = true; // 入力欄を無効化
    submitBtn.disabled = true; // 解答ボタンを無効化
});

// ゲーム終了（正解発表と結果表示の準備）
socket.on('gameOver', (data) => {
    stopTimer(); // タイマー停止
    showResult();
    gameOverMessageEl.textContent = `ゲーム終了！`;
    if (data.correctAnswererId && data.correctAnswererTime !== null) {
        correctAnswererInfoEl.innerHTML = `最も早かったのは **${data.correctAnswererName}** さん！<br>タイム: ${data.correctAnswererTime.toFixed(2)}秒`;
        correctAnswererInfoEl.style.color = '#2e7d32'; // 緑色
        correctAnswererInfoEl.style.fontWeight = 'bold';
    } else {
        correctAnswererInfoEl.textContent = '正解者はいませんでした...';
        correctAnswererInfoEl.style.color = '#d32f2f'; // 赤色
        correctAnswererInfoEl.style.fontWeight = 'normal';
    }
    correctAnswerDisplayEl.textContent = `正解は「${data.correctAnswer}」でした。`;
});

socket.on('feedback', (message) => {
    feedbackEl.textContent = message;
});


// ===== フリックキーボード処理 (変更なし) =====
const flickData = {
    あ: ["ウ", "エ", "オ", "イ", "ア"],
    か: ["ク", "ケ", "コ", "キ", "カ"],
    さ: ["ス", "セ", "ソ", "シ", "サ"],
    た: ["ツ", "テ", "ト", "チ", "タ"],
    な: ["ヌ", "ネ", "ノ", "ニ", "ナ"],
    は: ["フ", "ヘ", "ホ", "ヒ", "ハ"],
    ま: ["ム", "メ", "モ", "ミ", "マ"],
    や: ["ユ", "", "ヨ", "", "ヤ"],
    ら: ["ル", "レ", "ロ", "リ", "ラ"],
    わ: ["ン", "ー", "", "ヲ", "ワ"]
};

const transformChainMap = {
    ツ: ["ツ", "ッ"],
    ハ: ["ハ", "バ", "パ"],
    ヒ: ["ヒ", "ビ", "ピ"],
    フ: ["フ", "ブ", "プ"],
    ヘ: ["ヘ", "ベ", "ペ"],
    ホ: ["ホ", "ボ", "ポ"],
    ア: ["ア", "ァ"],
    イ: ["イ", "ィ"],
    ウ: ["ウ", "ゥ"],
    エ: ["エ", "ェ"],
    オ: ["オ", "ォ"],
    カ: ["カ", "ガ"],
    キ: ["キ", "ギ"],
    ク: ["ク", "グ"],
    ケ: ["ケ", "ゲ"],
    コ: ["コ", "ゴ"],
    サ: ["サ", "ザ"],
    シ: ["シ", "ジ"],
    ス: ["ス", "ズ"],
    セ: ["セ", "ゼ"],
    ソ: ["ソ", "ゾ"],
    タ: ["タ", "ダ"],
    チ: ["チ", "ヂ"],
    テ: ["テ", "デ"],
    ト: ["ト", "ド"],
    ヤ: ["ヤ", "ャ"],
    ユ: ["ユ", "ュ"],
    ヨ: ["ヨ", "ョ"],
    ワ: ["ワ", "ヮ"]
};

let startX = 0, startY = 0;

function createBtn(base) {
    const [up, right, down, left, center] = flickData[base];
    const btn = document.createElement("button");
    btn.className = "flick-btn";
    btn.dataset.base = base;
    btn.innerHTML = `
        <span class="hint top">${up}</span>
        <span class="hint right">${right}</span>
        <span class="hint bottom">${down}</span>
        <span class="hint left">${left}</span>
        <span class="center">${center}</span>
    `;
    btn.addEventListener("touchstart", e => {
        const t = e.touches[0];
        startX = t.clientX;
        startY = t.clientY;
    });
    btn.addEventListener("touchend", e => {
        const t = e.changedTouches[0];
        const dx = t.clientX - startX;
        const dy = t.clientY - startY;
        const th = 30;
        let dir = 4;
        if (Math.abs(dx) > Math.abs(dy)) {
            if (dx > th) dir = 1;
            else if (dx < -th) dir = 3;
        } else {
            if (dy > th) dir = 2;
            else if (dy < -th) dir = 0;
        }
        const kana = flickData[base][dir];
        if (kana) answerEl.value += kana;
    });
    btn.addEventListener("touchmove", e => e.preventDefault(), { passive: false });
    return btn;
}

const grid = document.getElementById("flick-grid");
Object.keys(flickData).forEach(base => {
    if (base !== "わ") grid.appendChild(createBtn(base));
});

const waBtn = document.querySelector('[data-base="わ"]');
waBtn.addEventListener("touchstart", e => {
    const t = e.touches[0];
    startX = t.clientX;
    startY = t.clientY;
});
waBtn.addEventListener("touchend", e => {
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    const th = 30;
    let dir = 4;
    if (Math.abs(dx) > Math.abs(dy)) {
        if (dx > th) dir = 1;
        else if (dx < -th) dir = 3;
    } else {
        if (dy > th) dir = 2;
        else if (dy < -th) dir = 0;
    }
    const kana = flickData["わ"][dir];
    if (kana) answerEl.value += kana;
});
waBtn.addEventListener("touchmove", e => e.preventDefault(), { passive: false });

document.getElementById("clear-btn").addEventListener("click", () => {
    answerEl.value = answerEl.value.slice(0, -1);
});

document.getElementById("modify-btn").addEventListener("click", () => {
    const val = answerEl.value;
    if (!val) return;
    const last = val.slice(-1);
    const rest = val.slice(0, -1);
    const chain = transformChainMap[last] || Object.entries(transformChainMap).find(([, arr]) => arr.includes(last))?.[1];
    if (!chain) return;
    const idx = chain.indexOf(last);
    const next = chain[(idx + 1) % chain.length];
    answerEl.value = rest + next;
});

// 物理入力・IME無効化
answerEl.addEventListener("keydown", e => e.preventDefault());
answerEl.addEventListener("beforeinput", e => e.preventDefault());
</script>
</body>
</html>