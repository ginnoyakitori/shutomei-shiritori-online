<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>クイズ早押し！</title>
    <style>
        html, body {
            overscroll-behavior: none;
            touch-action: manipulation;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            text-align: center;
        }

        body {
            padding: 0px;
        }

        input, button, select {
            font-size: 1rem;
            margin: 5px;
            padding: 0px;
        }

        #lobby-box, #quiz-box, #result-box, #room-box {
            display: none;
            max-width: 500px;
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        #answer {
            font-size: 1.6em;
            width: 90%;
            padding: 0px;
            margin-bottom: 12px;
            border: 2px solid #ccc;
            border-radius: 6px;
            background: #f9f9f9;
        }

        #question-number {
            font-weight: bold;
            margin-bottom: 0em;
            font-size: 1.1rem;
            color: #333;
        }

        #top-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 400px;
            margin: 0 auto 0px auto;
        }

        #timer {
            font-weight: bold;
            margin-bottom: 0em;
            font-size: 1.1rem;
            color: #333;
        }

        #question-number {
            font-size: 1.2em;
            text-align: right;
        }

        /* ボタン共通設定 */
        .flick-btn, #control-row button {
            position: relative;
            width: 70px;
            max-width: 70px;
            height:70px;
            max-height: 70px;
            background: #eef;
            font-size: 2em;
            border-radius: 8px;
            border: none;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            touch-action: none;
            box-sizing: border-box;
            overflow: hidden;
        }

        #flick-grid {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            grid-template-rows: repeat(4, 65px);
            gap: 15px;
            justify-content: center;
            margin: 0 auto;
            transform: translate(-2px, -4px);
        }

        .flick-btn .center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            font-weight: bold;
            color: #000;
        }

        .flick-btn .hint {
            position: absolute;
            font-size: 0.6em;
            opacity: 0.6;
            pointer-events: none;
            color: #000;
        }

        .flick-btn .top { top: -3px; left: 50%; transform: translateX(-50%); }
        .flick-btn .right { right: -3px; top: 50%; transform: translateY(-50%); }
        .flick-btn .bottom { bottom: -3px; left: 50%; transform: translateX(-50%); }
        .flick-btn .left { left: -3px; top: 50%; transform: translateY(-50%); }

        #control-row {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: -2px;
            touch-action: none;
            transform: translate(0, -65px);
        }
        #modify-btn, #clear-btn {
            width: 70px;
            height: 70px;
            font-size: 2.5em;
            font-weight: bold;
            border-radius: 10px;
            border: none;
            background: #f4f4f4;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            touch-action: none;
        }

        #submit-btn {
            width: 60vw;
            max-width: 300px;
            height: 17vw;
            max-height: 80px;
            font-size: 1.6em;
            font-weight: bold;
            border-radius: 10px;
            background: #cce;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            margin-top:-7px;
            transform: translate(0, -52px);
        }
        #question {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 0em;
        }

        /* 部屋リスト */
        #room-list {
            margin-top: 20px;
            text-align: left;
            border-collapse: collapse;
            width: 100%;
        }
        #room-list th, #room-list td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        #room-list th {
            background-color: #f2f2f2;
        }
        #room-list tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .room-button {
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
        }
        .room-button.create {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .room-button.join {
            background-color: #008CBA;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .room-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        /* 新しく追加する「部屋を作成」ボタンのスタイル */
        #show-create-room-modal-btn, #toggle-room-list-btn, #show-join-by-id-modal-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
            margin-right: 10px; /* ボタン間のスペース */
        }
        #toggle-room-list-btn {
            background-color: #007bff; /* 異なる色で視認性向上 */
        }
        #show-join-by-id-modal-btn {
            background-color: #6c757d; /* 異なる色で視認性向上 */
        }


        /* ルーム詳細画面 */
        #room-detail {
            margin-top: 20px;
            text-align: left;
        }
        #room-info p {
            margin: 5px 0;
        }
        #player-list {
            list-style: none;
            padding: 0;
        }
        #player-list li {
            background-color: #eee;
            margin-bottom: 5px;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-status {
            font-size: 0.8em;
            color: #666;
        }
        .player-status.ready {
            color: green;
            font-weight: bold;
        }
        .host-label {
            background-color: #ffeb3b;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            margin-left: 5px;
        }
        .ready-btn {
            background-color: #2196F3;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .ready-btn.unready {
            background-color: #f44336;
        }
        .ready-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* クイズタイプ選択 */
        #quiz-type-selection {
            margin-bottom: 15px;
        }
        #quiz-type-selection button {
            padding: 8px 15px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        #quiz-type-selection button.selected {
            background-color: #aaddff;
            border-color: #007bff;
        }

        /* ゲーム結果表示 */
        #result-box #game-over-message {
            font-size: 1.5em;
            color: #d32f2f;
            margin-bottom: 10px;
        }
        #result-box #correct-answerer-info {
            font-size: 1.3em;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 5px;
        }
        #result-box #correct-answer-display {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 20px;
        }
        #time-taken-display {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 20px;
        }
        #return-to-lobby-btn {
            background-color: #607d8b;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h1 id="main-title">クイズ早押し！</h1>

<div id="lobby-box">
    <h2>部屋一覧</h2>
    <button id="toggle-room-list-btn">部屋一覧を非表示</button> <button id="show-create-room-modal-btn">部屋を作成</button>
    <button id="show-join-by-id-modal-btn">ルームIDで入室</button> <table id="room-list">
        <thead>
            <tr>
                <th>部屋名</th>
                <th>人数</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
    
    <div id="create-room-modal" style="display: none; border: 1px solid #ccc; padding: 10px; margin-top: 20px; background-color: #fff;">
        <h3>新しい部屋を作成</h3>
        <input type="text" id="create-room-name" placeholder="部屋名" maxlength="20"><br>
        <input type="text" id="create-nickname" placeholder="あなたのニックネーム" maxlength="15"><br>
        <br>
        <button id="confirm-create-room-btn">作成</button>
        <button id="cancel-create-room-btn">キャンセル</button>
    </div>

    <div id="join-room-modal" style="display: none; border: 1px solid #ccc; padding: 10px; margin-top: 20px; background-color: #fff;">
        <h3 id="join-room-modal-title"></h3>
        <input type="text" id="join-nickname" placeholder="あなたのニックネーム" maxlength="15"><br>
        <br>
        <button id="confirm-join-room-btn">入室</button>
        <button id="cancel-join-room-btn">キャンセル</button>
        <input type="hidden" id="joining-room-id">
    </div>

    <div id="join-by-id-modal" style="display: none; border: 1px solid #ccc; padding: 10px; margin-top: 20px; background-color: #fff;">
        <h3>ルームIDで入室</h3>
        <input type="text" id="join-by-id-room-id" placeholder="4桁のルームID" maxlength="4"><br>
        <input type="text" id="join-by-id-nickname" placeholder="あなたのニックネーム" maxlength="15"><br>
        <button id="confirm-join-by-id-btn">入室</button>
        <button id="cancel-join-by-id-btn">キャンセル</button>
    </div>
</div>

<div id="room-box">
    <div id="room-detail">
        <h2 id="current-room-name"></h2>
        <p>部屋ID: <span id="current-room-id"></span></p>
        <h3>プレイヤー:</h3>
        <ul id="player-list"></ul>

        <div id="host-controls" style="display: none;">
            <h4>クイズタイプを選択:</h4>
            <div id="quiz-type-selection">
                <button class="quiz-type-btn" data-type="kokumei">首都名から国名</button>
                <button class="quiz-type-btn" data-type="shutomei">国名から首都名</button>
            </div>
            <p id="selected-quiz-type-display"></p>
            <button id="start-game-btn" disabled>ゲームを開始</button>
        </div>

        <button id="ready-btn" class="ready-btn">準備完了</button>
        <button id="leave-room-btn" style="background-color: gray; color: white; margin-left: 10px; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">部屋を出る</button>
    </div>
</div>

<div id="quiz-box">
    <div id="top-info">
        <div id="question-number"></div>
        <div id="timer">0.00</div>
    </div>
    <div id="question"></div>

    <input id="answer" placeholder="答えを入力" readonly />
    <div id="flick-grid"></div>

    <div id="control-row">
        <button id="modify-btn">濁/小</button>
        <button class="flick-btn" data-base="わ">
            <span class="hint top">ン</span>
            <span class="hint right">ー</span>
            <span class="hint left">ヲ</span>
            <span class="center">ワ</span>
        </button>
        <button id="clear-btn">消</button>
    </div>

    <button id="submit-btn">解答</button>
    <div id="feedback"></div>
</div>

<div id="result-box">
    <p id="game-over-message"></p>
    <p id="correct-answerer-info"></p>
    <p id="correct-answer-display"></p>
    <p id="time-taken-display"></p>
    <button id="return-to-lobby-btn">待機画面に戻る</button>
</div>

<script type="module">
// Socket.IO クライアントの初期化
const socket = io();

// ===== DOM要素の取得 =====
const mainTitle = document.getElementById("main-title");
const lobbyBox = document.getElementById("lobby-box");
const roomListTable = document.getElementById("room-list"); // table要素を取得
const roomListTableBody = roomListTable.querySelector("tbody"); // tbody要素を取得

// 新しいボタンの取得
const showCreateRoomModalBtn = document.getElementById("show-create-room-modal-btn");
const toggleRoomListBtn = document.getElementById("toggle-room-list-btn"); // 追加: 表示/非表示ボタン
const showJoinByIdModalBtn = document.getElementById("show-join-by-id-modal-btn"); // 追加: ルームIDで入室ボタン

const createRoomModal = document.getElementById("create-room-modal");
const createRoomNameInput = document.getElementById("create-room-name");
const createNicknameInput = document.getElementById("create-nickname");
// const createRoomPasswordInput = document.getElementById("create-room-password"); // 削除

const joinRoomModal = document.getElementById("join-room-modal");
const joinRoomModalTitle = document.getElementById("join-room-modal-title");
const joinNicknameInput = document.getElementById("join-nickname");
// const joinRoomPasswordInput = document.getElementById("join-room-password"); // 削除
const confirmJoinRoomBtn = document.getElementById("confirm-join-room-btn");
const cancelJoinRoomBtn = document.getElementById("cancel-join-room-btn");
const joiningRoomIdInput = document.getElementById("joining-room-id");

// ルームIDで入室用モーダルの要素
const joinByIdModal = document.getElementById("join-by-id-modal");
const joinByIdRoomIdInput = document.getElementById("join-by-id-room-id");
const joinByIdNicknameInput = document.getElementById("join-by-id-nickname");
const confirmJoinByIdBtn = document.getElementById("confirm-join-by-id-btn");
const cancelJoinByIdBtn = document.getElementById("cancel-join-by-id-btn");


const roomBox = document.getElementById("room-box");
const currentRoomNameEl = document.getElementById("current-room-name");
const currentRoomIdEl = document.getElementById("current-room-id");
const playerListEl = document.getElementById("player-list");
const hostControls = document.getElementById("host-controls");
const quizTypeSelection = document.getElementById("quiz-type-selection");
const quizTypeBtns = document.querySelectorAll(".quiz-type-btn");
const selectedQuizTypeDisplay = document.getElementById("selected-quiz-type-display");
const startGameBtn = document.getElementById("start-game-btn");
const readyBtn = document.getElementById("ready-btn");
const leaveRoomBtn = document.getElementById("leave-room-btn");

const quizBox = document.getElementById("quiz-box");
const questionEl = document.getElementById("question");
const questionNumberEl = document.getElementById("question-number");
const timerEl = document.getElementById("timer");
const answerEl = document.getElementById("answer");
const feedbackEl = document.getElementById("feedback");
const submitBtn = document.getElementById("submit-btn");

const resultBox = document.getElementById("result-box");
const gameOverMessageEl = document.getElementById("game-over-message");
const correctAnswererInfoEl = document.getElementById("correct-answerer-info");
const correctAnswerDisplayEl = document.getElementById("correct-answer-display");
const timeTakenDisplayEl = document.getElementById("time-taken-display");
const returnToLobbyBtn = document.getElementById("return-to-lobby-btn");


// ===== グローバル変数 =====
let currentRoomId = null;
let myPlayerId = null;
let isHost = false;
let gameStartTime = null; // ゲームが開始された時刻
let isRoomListVisible = true; // 部屋リストの表示状態を管理

// ===== 初期表示 =====
showLobby();

// ===== 画面表示切り替え関数 =====
function showLobby() {
    lobbyBox.style.display = "block";
    roomBox.style.display = "none";
    quizBox.style.display = "none";
    resultBox.style.display = "none";
    mainTitle.style.display = "block";
    createRoomModal.style.display = "none";
    joinRoomModal.style.display = "none";
    joinByIdModal.style.display = "none"; // 追加
    currentRoomId = null;
    myPlayerId = socket.id; // ロビー画面でも自分のソケットIDはわかる
    isHost = false;
    console.log("ロビー画面を表示しました。"); // ロギング追加
}

function showRoomWaiting() {
    lobbyBox.style.display = "none";
    roomBox.style.display = "block";
    quizBox.style.display = "none";
    resultBox.style.display = "none";
    mainTitle.style.display = "none";
    console.log("部屋待機画面を表示しました。"); // ロギング追加
}

function showQuizGame() {
    lobbyBox.style.display = "none";
    roomBox.style.display = "none";
    quizBox.style.display = "block";
    resultBox.style.display = "none";
    mainTitle.style.display = "none";
    console.log("クイズゲーム画面を表示しました。"); // ロギング追加
}

function showResult() {
    lobbyBox.style.display = "none";
    roomBox.style.display = "none";
    quizBox.style.display = "none";
    resultBox.style.display = "block";
    mainTitle.style.display = "none";
    console.log("結果画面を表示しました。"); // ロギング追加
}

// ===== イベントリスナー =====

// 新しい「部屋を作成」ボタンのクリックイベント
showCreateRoomModalBtn.addEventListener('click', () => {
    createRoomModal.style.display = 'block';
    createRoomNameInput.value = ''; // 入力欄をクリア
    createNicknameInput.value = ''; // 入力欄をクリア
    console.log("「部屋を作成」ボタンから部屋作成モーダルを開きました。");
});

// 「部屋一覧を表示/非表示」ボタンのクリックイベント
toggleRoomListBtn.addEventListener('click', () => {
    isRoomListVisible = !isRoomListVisible;
    roomListTable.style.display = isRoomListVisible ? 'table' : 'none';
    toggleRoomListBtn.textContent = isRoomListVisible ? '部屋一覧を非表示' : '部屋一覧を表示';
    console.log(`部屋一覧の表示状態を切り替えました: ${isRoomListVisible ? '表示' : '非表示'}`);
    // 部屋リストの表示状態が変わったので、現在の部屋リストを再描画する
    // socket.on('roomList') ハンドラ内で isRoomListVisible をチェックして描画を制御するため、
    // ここで何か特別な処理は不要（roomListイベントが受信されれば自動的に反映される）
    // もしroomListイベントが頻繁に発生しない場合は、現在の表示データを使ってローカルで再描画する必要があるが、
    // サーバーからのroomListイベントでUIが更新されるため、このままでOK
});


// 「ルームIDで入室」ボタンのクリックイベント
showJoinByIdModalBtn.addEventListener('click', () => {
    joinByIdModal.style.display = 'block';
    joinByIdRoomIdInput.value = ''; // 入力欄をクリア
    joinByIdNicknameInput.value = ''; // 入力欄をクリア
    console.log("「ルームIDで入室」モーダルを開きました。");
});


// 部屋参加ボタンクリック (動的に生成されるので親要素にイベント委譲)
roomListTableBody.addEventListener('click', (e) => {
    if (e.target.classList.contains('room-button')) {
        const roomId = e.target.dataset.roomId;
        const roomName = e.target.dataset.roomName; // 部屋名も取得
        console.log(`テーブルの部屋ボタンクリック: Room ID: ${roomId}, Room Name: ${roomName}, Type: Join`); // ロギング追加

        if (e.target.classList.contains('join')) {
            // 参加モーダル表示
            joinRoomModal.style.display = 'block';
            joinRoomModalTitle.textContent = `部屋「${roomName}」に参加`;
            joiningRoomIdInput.value = roomId;
            // パスワード入力欄は削除されたため、ここでの表示/非表示ロジックも不要
            console.log(`部屋参加モーダルを開きました: Room ID: ${roomId}, Room Name: ${roomName}`); // ロギング追加
        }
    }
});

// 部屋作成モーダル内の「作成」ボタン
confirmCreateRoomBtn.addEventListener('click', () => {
    console.log("モーダル内の「作成」ボタンがクリックされました。(addEventListener)");
    const roomName = createRoomNameInput.value.trim();
    const nickname = createNicknameInput.value.trim();
    if (!roomName || !nickname) {
        alert('部屋名とニックネームは必須です。');
        console.warn("部屋名またはニックネームが入力されていません。alertが表示されました。");
        return;
    }
    console.log(`部屋作成リクエストをSocket.IOで送信中... 部屋名: ${roomName}, ニックネーム: ${nickname}`);
    // パスワードを削除
    socket.emit('createRoom', { roomName, nickname });
    // モーダルはサーバーからのroomCreatedイベントで閉じる
});

cancelCreateRoomBtn.addEventListener('click', () => {
    createRoomModal.style.display = 'none';
    console.log("部屋作成モーダルを閉じました。");
});

// 部屋参加モーダル内の「入室」ボタン
confirmJoinRoomBtn.addEventListener('click', () => {
    console.log("モーダル内の「入室」ボタンがクリックされました。");
    const roomId = joiningRoomIdInput.value;
    const nickname = joinNicknameInput.value.trim();
    if (!nickname) {
        alert('ニックネームは必須です。');
        console.warn("ニックネームが入力されていません。alertが表示されました。");
        return;
    }
    console.log(`部屋参加リクエストをSocket.IOで送信中... 部屋ID: ${roomId}, ニックネーム: ${nickname}`);
    // パスワードを削除
    socket.emit('joinRoom', { roomId, nickname });
    // モーダルはサーバーからのroomJoinedイベントで閉じる
});

cancelJoinRoomBtn.addEventListener('click', () => {
    joinRoomModal.style.display = 'none';
    console.log("部屋参加モーダルを閉じました。");
});


// ルームIDで入室モーダル内の「入室」ボタン
confirmJoinByIdBtn.addEventListener('click', () => {
    const roomId = joinByIdRoomIdInput.value.trim();
    const nickname = joinByIdNicknameInput.value.trim();

    if (!roomId || roomId.length !== 4 || isNaN(roomId)) {
        alert('有効な4桁のルームIDを入力してください。');
        return;
    }
    if (!nickname) {
        alert('ニックネームは必須です。');
        return;
    }
    console.log(`ルームIDで入室リクエストをSocket.IOで送信中... ルームID: ${roomId}, ニックネーム: ${nickname}`);
    socket.emit('joinRoom', { roomId, nickname }); // パスワードは不要
});

cancelJoinByIdBtn.addEventListener('click', () => {
    joinByIdModal.style.display = 'none';
    console.log("ルームIDで入室モーダルを閉じました。");
});


// 準備完了ボタン
readyBtn.addEventListener('click', () => {
    if (!currentRoomId) return;
    const myPlayerLi = document.getElementById(myPlayerId);
    if (!myPlayerLi) return;
    const isReady = myPlayerLi.dataset.ready === 'false' || !myPlayerLi.dataset.ready;
    socket.emit('setReady', { roomId: currentRoomId, isReady: isReady });
    console.log(`準備状態変更リクエスト送信: Room ID: ${currentRoomId}, 状態: ${isReady}`);
});

// 部屋を出るボタン
leaveRoomBtn.addEventListener('click', () => {
    if (currentRoomId) {
        socket.emit('leaveRoom', currentRoomId);
        console.log(`部屋退出リクエスト送信: Room ID: ${currentRoomId}`);
    }
    // 接続を切断し、再接続することで新しいソケットIDを取得し、ロビーに戻る
    socket.disconnect();
    socket.connect();
    showLobby();
});

// クイズタイプ選択ボタン (ホストのみ)
quizTypeBtns.forEach(button => {
    button.addEventListener('click', () => {
        if (!isHost) return;
        const type = button.dataset.type;
        socket.emit('selectQuizType', { roomId: currentRoomId, type: type });
        console.log(`クイズタイプ選択リクエスト送信: Room ID: ${currentRoomId}, タイプ: ${type}`);
    });
});

// ゲーム開始ボタン (ホストのみ)
startGameBtn.addEventListener('click', () => {
    if (!currentRoomId || !isHost) return;
    socket.emit('startGame', currentRoomId);
    console.log(`ゲーム開始リクエスト送信: Room ID: ${currentRoomId}`);
});

// 解答送信ボタン
submitBtn.addEventListener('click', () => {
    if (!currentRoomId) return;
    const answer = answerEl.value.trim();
    if (answer) {
        socket.emit('submitAnswer', currentRoomId, answer);
        console.log(`解答送信リクエスト: Room ID: ${currentRoomId}, 解答: ${answer}`);
    }
});

// 待機画面に戻るボタン (結果画面からホストのみ)
returnToLobbyBtn.addEventListener('click', () => {
    if (!currentRoomId || !isHost) return;
    socket.emit('returnToLobby', currentRoomId);
    console.log(`ロビーに戻るリクエスト送信 (ホスト): Room ID: ${currentRoomId}`);
});

// ===== Socket.IO イベントハンドラ =====

// 部屋リストの更新
socket.on('roomList', (rooms) => {
    console.log("--- roomList イベントを受信しました ---");
    console.log("受信した部屋データ:", rooms);
    roomListTableBody.innerHTML = ''; // テーブルの中身をクリア
    
    // 部屋リストが非表示設定の場合、何もしない（テーブルは空のまま）
    if (!isRoomListVisible) {
        console.log("部屋一覧は現在非表示に設定されています。");
        return;
    }

    // 「空き部屋」の行を表示しないため、roomsが空の場合はここで処理を終了
    if (!rooms || rooms.length === 0) {
        console.log("部屋データが空または無効です。部屋一覧には何も表示されません。");
        return;
    }

    rooms.forEach(room => {
        // 空き部屋は表示しない
        if (room.status === 'empty') { // この条件は通常発生しないが、念のため
            return; // この部屋はスキップして次の部屋へ
        }

        const row = roomListTableBody.insertRow();
        let buttonHtml = '';
        let playersText = '';
        let roomNameText = room.name;

        // 既存の部屋（waiting, playing, finished）のみを処理
        const isDisabled = room.status === 'playing' ? 'disabled' : '';
        // パスワード有無の表示を削除
        buttonHtml = `<button class="room-button join" data-room-id="${room.id}" data-room-name="${roomNameText}" ${isDisabled}>入室</button>`;
        playersText = `${room.playersCount}/${room.maxPlayers}`;
        
        row.innerHTML = `
            <td>${roomNameText}</td>
            <td>${playersText}</td>
            <td>${buttonHtml}</td>
        `;
        console.log(`部屋の行を追加: ID: ${room.id}, 名前: ${roomNameText}, ステータス: ${room.status}`);
    });
});

// 部屋作成成功
socket.on('roomCreated', (roomId) => {
    currentRoomId = roomId;
    myPlayerId = socket.id;
    isHost = true;
    createRoomModal.style.display = 'none'; // モーダルを閉じる
    showRoomWaiting();
    console.log(`部屋作成成功: Room ID: ${roomId}`);
});

// 部屋参加成功
socket.on('roomJoined', (roomId) => {
    currentRoomId = roomId;
    myPlayerId = socket.id;
    joinRoomModal.style.display = 'none'; // 通常の参加モーダルを閉じる
    joinByIdModal.style.display = 'none'; // ルームIDで入室モーダルも閉じる
    showRoomWaiting();
    console.log(`部屋参加成功: Room ID: ${roomId}`);
});

// 部屋のエラー
socket.on('roomError', (message) => {
    alert(message);
    showLobby(); 
    console.error(`部屋エラー: ${message}`);
});

// 部屋の状態更新
socket.on('roomState', (room) => {
    console.log("--- roomState イベントを受信しました ---");
    console.log("受信した部屋の状態:", room);

    // 自分のプレイヤーIDがまだ設定されていなくて、かつroom.playersに自分がいる場合に画面を切り替える
    // もしくは、現在の部屋IDと受信した部屋IDが一致しないが、自分がその部屋にいる場合も考慮
    if (!currentRoomId || (room.id !== currentRoomId && room.players.some(p => p.id === socket.id))) {
        currentRoomId = room.id;
        myPlayerId = socket.id;
        showRoomWaiting();
        console.log(`部屋の状態更新により画面切り替え: Room ID: ${room.id}`);
    } else if (currentRoomId && room.id !== currentRoomId) {
        // 現在の部屋と一致しないroomStateイベントを無視 (自分がその部屋にいない場合)
        console.log("現在の部屋と一致しないroomStateイベントを無視しました (自分はこの部屋にいません)。");
        return;
    }


    currentRoomNameEl.textContent = room.name;
    currentRoomIdEl.textContent = room.id;
    
    playerListEl.innerHTML = '';
    room.players.forEach(player => {
        const li = document.createElement('li');
        li.id = player.id;
        li.dataset.ready = player.ready;
        li.innerHTML = `
            <span>${player.name}</span>
            ${player.isHost ? '<span class="host-label">HOST</span>' : ''}
            <span class="player-status ${player.ready ? 'ready' : ''}">
                ${player.ready ? '準備OK' : '未準備'}
            </span>
        `;
        playerListEl.appendChild(li);
    });

    const myPlayer = room.players.find(p => p.id === myPlayerId);
    isHost = myPlayer ? myPlayer.isHost : false;

    if (isHost) {
        hostControls.style.display = 'block';
        quizTypeBtns.forEach(btn => btn.classList.remove('selected'));
        if (room.quizType) {
            const selectedBtn = document.querySelector(`.quiz-type-btn[data-type="${room.quizType}"]`);
            if (selectedBtn) {
                 selectedBtn.classList.add('selected');
            }
            selectedQuizTypeDisplay.textContent = `選択中のクイズ: ${room.quizType === 'kokumei' ? '首都名から国名' : '国名から首都名'}`;
        } else {
            selectedQuizTypeDisplay.textContent = 'クイズタイプを選択してください';
        }

        // ゲーム開始ボタンの有効/無効
        // ゲームが待機中で、かつクイズタイプが選択されていれば有効
        startGameBtn.disabled = !(room.status === 'waiting' && room.quizType && room.players.length >= 1 && room.players.every(p => p.ready));
        returnToLobbyBtn.style.display = (room.status === 'finished') ? 'block' : 'none';
    } else {
        hostControls.style.display = 'none';
        returnToLobbyBtn.style.display = 'none';
    }

    if (myPlayer) {
        readyBtn.textContent = myPlayer.ready ? '準備解除' : '準備完了';
        readyBtn.classList.toggle('unready', myPlayer.ready);
        readyBtn.disabled = (room.status !== 'waiting');
    }
    
    if (room.status === 'finished') {
        showResult();
        gameOverMessageEl.textContent = `ゲーム終了！`;
        if (room.correctAnswerer && room.correctAnswererTime !== null) {
            correctAnswererInfoEl.innerHTML = `最も早かったのは **${room.correctAnswererName}** さん！<br>タイム: ${room.correctAnswererTime.toFixed(2)}秒`;
            correctAnswererInfoEl.style.color = '#2e7d32';
            correctAnswererInfoEl.style.fontWeight = 'bold';
        } else {
            correctAnswererInfoEl.textContent = '正解者はいませんでした...';
            correctAnswererInfoEl.style.color = '#d32f2f';
            correctAnswererInfoEl.style.fontWeight = 'normal';
        }
        correctAnswerDisplayEl.textContent = `正解は「${room.correctAnswer}」でした。`;
    }
});

// 新しいプレイヤーが参加 (デバッグ用。roomStateで更新される)
socket.on('playerJoined', (player) => {
    console.log(`プレイヤーが参加しました: ${player.name} (${player.id})`);
});

// プレイヤーが退出 (デバッグ用。roomStateで更新される)
socket.on('playerLeft', (playerId, playerName) => {
    console.log(`プレイヤーが退出しました: ${playerName} (${playerId})`);
});

// 新しいホストが設定された
socket.on('newHost', (newHostId) => {
    if (newHostId === myPlayerId) {
        alert('あなたが新しいホストになりました！');
    }
    console.log(`新しいホスト: ${newHostId}`);
});

// ゲーム開始
socket.on('gameStarted', () => {
    showQuizGame();
    gameStartTime = Date.now();
    feedbackEl.textContent = '';
    answerEl.value = '';
    timerEl.textContent = '0.00';
    console.log("ゲームが開始されました。");
});

// 新しい問題が出題
socket.on('newQuestion', (data) => {
    questionEl.textContent = data.text;
    questionNumberEl.textContent = `問題 ${data.questionNumber}`;
    answerEl.value = '';
    feedbackEl.textContent = '';
    submitBtn.disabled = false;
    answerEl.readOnly = false;
    gameStartTime = Date.now();
    startTimer();
    console.log(`新しい問題が出題: ${data.text} (問題 ${data.questionNumber})`);
});

let timerIntervalId;
function startTimer() {
    if (timerIntervalId) clearInterval(timerIntervalId);
    timerIntervalId = setInterval(() => {
        const elapsed = (Date.now() - gameStartTime) / 1000;
        timerEl.textContent = `${elapsed.toFixed(2)}秒`;
    }, 10);
}

function stopTimer() {
    clearInterval(timerIntervalId);
    timerIntervalId = null;
    console.log("タイマー停止。");
}

// 正解者通知
socket.on('correctAnswer', (data) => {
    stopTimer();
    feedbackEl.textContent = '正解！';
    answerEl.readOnly = true;
    submitBtn.disabled = true;
    console.log(`正解者が出ました: ${data.playerId}, スコア: ${data.score}`);
});

// ゲーム終了（正解発表と結果表示の準備）
socket.on('gameOver', (data) => {
    stopTimer();
    showResult();
    gameOverMessageEl.textContent = `ゲーム終了！`;
    if (data.correctAnswererId && data.correctAnswererTime !== null) {
        correctAnswererInfoEl.innerHTML = `最も早かったのは **${data.correctAnswererName}** さん！<br>タイム: ${data.correctAnswererTime.toFixed(2)}秒`;
        correctAnswererInfoEl.style.color = '#2e7d32';
        correctAnswererInfoEl.style.fontWeight = 'bold';
    } else {
        correctAnswererInfoEl.textContent = '正解者はいませんでした...';
        correctAnswererInfoEl.style.color = '#d32f2f';
        correctAnswererInfoEl.style.fontWeight = 'normal';
    }
    correctAnswerDisplayEl.textContent = `正解は「${data.correctAnswer}」でした。`;
    console.log("ゲーム終了イベント受信。");
});

socket.on('feedback', (message) => {
    feedbackEl.textContent = message;
    console.log(`フィードバック: ${message}`);
});


// ===== フリックキーボード処理 (変更なし) =====
const flickData = {
    あ: ["ウ", "エ", "オ", "イ", "ア"],
    か: ["ク", "ケ", "コ", "キ", "カ"],
    さ: ["ス", "セ", "ソ", "シ", "サ"],
    た: ["ツ", "テ", "ト", "チ", "タ"],
    な: ["ヌ", "ネ", "ノ", "ニ", "ナ"],
    は: ["フ", "ヘ", "ホ", "ヒ", "ハ"],
    ま: ["ム", "メ", "モ", "ミ", "マ"],
    や: ["ユ", "", "ヨ", "", "ヤ"],
    ら: ["ル", "レ", "ロ", "リ", "ラ"],
    わ: ["ン", "ー", "", "ヲ", "ワ"]
};

const transformChainMap = {
    ツ: ["ツ", "ッ"],
    ハ: ["ハ", "バ", "パ"],
    ヒ: ["ヒ", "ビ", "ピ"],
    フ: ["フ", "ブ", "プ"],
    ヘ: ["ヘ", "ベ", "ペ"],
    ホ: ["ホ", "ボ", "ポ"],
    ア: ["ア", "ァ"],
    イ: ["イ", "ィ"],
    ウ: ["ウ", "ゥ"],
    エ: ["エ", "ェ"],
    オ: ["オ", "ォ"],
    カ: ["カ", "ガ"],
    キ: ["キ", "ギ"],
    ク: ["ク", "グ"],
    ケ: ["ケ", "ゲ"],
    コ: ["コ", "ゴ"],
    サ: ["サ", "ザ"],
    シ: ["シ", "ジ"],
    ス: ["ス", "ズ"],
    セ: ["セ", "ゼ"],
    ソ: ["ソ", "ゾ"],
    タ: ["タ", "ダ"],
    チ: ["チ", "ヂ"],
    テ: ["テ", "デ"],
    ト: ["ト", "ド"],
    ヤ: ["ヤ", "ャ"],
    ユ: ["ユ", "ュ"],
    ヨ: ["ヨ", "ョ"],
    ワ: ["ワ", "ヮ"]
};

let startX = 0, startY = 0;

function createBtn(base) {
    const [up, right, down, left, center] = flickData[base];
    const btn = document.createElement("button");
    btn.className = "flick-btn";
    btn.dataset.base = base;
    btn.innerHTML = `
        <span class="hint top">${up}</span>
        <span class="hint right">${right}</span>
        <span class="hint bottom">${down}</span>
        <span class="hint left">${left}</span>
        <span class="center">${center}</span>
    `;
    btn.addEventListener("touchstart", e => {
        const t = e.touches[0];
        startX = t.clientX;
        startY = t.clientY;
    });
    btn.addEventListener("touchend", e => {
        const t = e.changedTouches[0];
        const dx = t.clientX - startX;
        const dy = t.clientY - startY;
        const th = 30;
        let dir = 4;
        if (Math.abs(dx) > Math.abs(dy)) {
            if (dx > th) dir = 1;
            else if (dx < -th) dir = 3;
        } else {
            if (dy > th) dir = 2;
            else if (dy < -th) dir = 0;
        }
        const kana = flickData[base][dir];
        if (kana) answerEl.value += kana;
    });
    btn.addEventListener("touchmove", e => e.preventDefault(), { passive: false });
    return btn;
}

const grid = document.getElementById("flick-grid");
Object.keys(flickData).forEach(base => {
    if (base !== "わ") grid.appendChild(createBtn(base));
});

const waBtn = document.querySelector('[data-base="わ"]');
waBtn.addEventListener("touchstart", e => {
    const t = e.touches[0];
    startX = t.clientX;
    startY = t.clientY;
});
waBtn.addEventListener("touchend", e => {
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    const th = 30;
    let dir = 4;
    if (Math.abs(dx) > Math.abs(dy)) {
        if (dx > th) dir = 1;
        else if (dx < -th) dir = 3;
    } else {
        if (dy > th) dir = 2;
        else if (dy < -th) dir = 0;
    }
    const kana = flickData["わ"][dir];
    if (kana) answerEl.value += kana;
});
waBtn.addEventListener("touchmove", e => e.preventDefault(), { passive: false });

document.getElementById("clear-btn").addEventListener("click", () => {
    answerEl.value = answerEl.value.slice(0, -1);
});

document.getElementById("modify-btn").addEventListener("click", () => {
    const val = answerEl.value;
    if (!val) return;
    const last = val.slice(-1);
    const rest = val.slice(0, -1);
    const chain = transformChainMap[last] || Object.entries(transformChainMap).find(([, arr]) => arr.includes(last))?.[1];
    if (!chain) return;
    const idx = chain.indexOf(last);
    const next = chain[(idx + 1) % chain.length];
    answerEl.value = rest + next;
});

// 物理入力・IME無効化
answerEl.addEventListener("keydown", e => e.preventDefault());
answerEl.addEventListener("beforeinput", e => e.preventDefault());
</script>
</body>
</html>